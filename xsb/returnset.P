:- export external_file_query/2.
:- import halt/1, tell/1, told/0, writeq/1, nl/0  from standard.
:- import term_variables/2 from setof.
:- import concat_atom/2 from string.
:- import rm/1 from shell.

external_file_query(FileBase,Query) :-
    concat_atom([FileBase,'.rules'],RuleFile),
    concat_atom([FileBase,'.facts'],FactFile),
    concat_atom([FileBase,'.answers'],AnswerFile),
    (file_exists(RuleFile)
     ->	true
     ;	writeln(warning('No Rule file.'))
    ),
    consult(RuleFile),
    (file_exists(FactFile)
     ->	load_dyn(FactFile)
     ;	true
    ),
    term_variables(Query,Variables),
    (file_exists(AnswerFile)
     ->	rm(AnswerFile)
     ;	true
    ),
    tell(AnswerFile),
    write('{'),
    (do_all
     call(Query),
     write('('),
     write_list(Variables),
     write(',),')
    ),
    write('}'),
    told,
    halt(0).

%write_list([]) :- nl.
write_list([E|L]) :-
    writeq(E),
    (L == []
     ->	true
     ;	write(','),
	write_list(L)
    ).