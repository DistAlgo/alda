:- export external_file_query/2.
:- import halt/1, tell/1, told/0, writeq/1, nl/0  from standard.
:- import term_variables/2 from setof.
:- import concat_atom/2 from string.
:- import rm/1 from shell.

external_file_query(FileBase,Query) :-
    concat_atom([FileBase,'.rules'],RuleFile),
    concat_atom([FileBase,'.facts'],FactFile),
    (file_exists(RuleFile)
     ->	true
     ;	writeln(warning('No Rule file.'))
    ),
    consult(RuleFile),
    (file_exists(FactFile)
     ->	load_dyn(FactFile)
     ;	true
    ),
    call_iter(Query),
    halt(0).

call_iter([]).
call_iter([E|L]) :-
    [A,B] = E,
    concat_atom([A,'.answers'],AnswerFile),
    term_variables(B,Variables),
    (file_exists(AnswerFile)
     -> rm(AnswerFile)
     ;  true
    ),
    tell(AnswerFile),
    (do_all
     call(B),
     write_list(Variables)
    ),
    told,
    call_iter(L).
    

write_list([]) :- nl.
write_list([E|L]) :-
    writeq(E),
    (L == []
     ->	nl
     ;	write(','),
	write_list(L)
    ).